Attribute VB_Name = "å˚ç¿ì¸óÕÉtÉHÅ[ÉÄ"
Option Explicit
Public Sub AddBasicControls(frmPayee As MSForms.Frame, payee As String, topOffset As Integer)
    ' ã‡äz
    frmPayee.Controls.Add "Forms.Label.1", "Label_Amount_" & payee
    frmPayee.Controls.Add "Forms.TextBox.1", "TextBox_Amount_" & payee
    With frmPayee.Controls("Label_Amount_" & payee)
        .caption = "ã‡äz"
        .Left = 10: .Top = topOffset: .Width = 40
    End With
    With frmPayee.Controls("TextBox_Amount_" & payee)
        .Left = 60: .Top = topOffset - 2: .Width = 80
    End With
    ' ìEóv1?3
    Dim j As Integer
    For j = 1 To 3
        frmPayee.Controls.Add "Forms.Label.1", "Label_Tekiyo" & j & "_" & payee
        frmPayee.Controls.Add "Forms.TextBox.1", "TextBox_Tekiyo" & j & "_" & payee
        With frmPayee.Controls("Label_Tekiyo" & j & "_" & payee)
            .caption = "ìEóv" & j
            .Left = 10: .Top = topOffset + 20 * j: .Width = 40
        End With
        With frmPayee.Controls("TextBox_Tekiyo" & j & "_" & payee)
            .Left = 60: .Top = topOffset + 20 * j - 2: .Width = 120
        End With
    Next j

    ' éxï•ì˙
    frmPayee.Controls.Add "Forms.Label.1", "Label_Date_" & payee
    frmPayee.Controls.Add "Forms.TextBox.1", "TextBox_Date_" & payee
    With frmPayee.Controls("Label_Date_" & payee)
        .caption = "éxï•ì˙"
        .Left = 10: .Top = topOffset + 80: .Width = 50
    End With
    With frmPayee.Controls("TextBox_Date_" & payee)
        .Left = 70: .Top = topOffset + 78: .Width = 100
        .Value = Format(DateSerial(year(Date), month(Date) + 1, 0), "yyyy/mm/dd")
    End With

    ' â»ñ⁄
    frmPayee.Controls.Add "Forms.Label.1", "Label_Kamoku_" & payee
    frmPayee.Controls.Add "Forms.ComboBox.1", "ComboBox_Kamoku_" & payee
    With frmPayee.Controls("Label_Kamoku_" & payee)
        .caption = "å˚ç¿Åiâ»ñ⁄Åj"
        .Left = 10: .Top = topOffset + 100: .Width = 80
    End With
    With frmPayee.Controls("ComboBox_Kamoku_" & payee)
        .Left = 100: .Top = topOffset + 98: .Width = 100
    End With

    ' ï‚èï
    frmPayee.Controls.Add "Forms.Label.1", "Label_Hojo_" & payee
    frmPayee.Controls.Add "Forms.ComboBox.1", "ComboBox_Hojo_" & payee
    With frmPayee.Controls("Label_Hojo_" & payee)
        .caption = "ï‚èï"
        .Left = 10: .Top = topOffset + 120: .Width = 80
    End With
    With frmPayee.Controls("ComboBox_Hojo_" & payee)
        .Left = 100: .Top = topOffset + 118: .Width = 100
    End With
End Sub

Public Sub ApplyInitialValues(frmPayee As MSForms.Frame, uniqueID As String, selectedMonth As Integer, selectedYear As Integer, category As String, denpyo As String)
    Dim payee As String
    payee = Split(uniqueID, "_")(0) ' ÉÜÉjÅ[ÉNIDÇ©ÇÁéÊà¯êÊñºÇíäèo

    Dim dataRow As Range
    Set dataRow = GetMonthlyDataRow(payee, category, denpyo, selectedYear, selectedMonth)

    If Not dataRow Is Nothing Then
        Call ApplyMonthlyHistoryToFrame(frmPayee, uniqueID, dataRow)
    Else
        Dim latestRow As Range
        Set latestRow = GetLatestHistoryRow(payee, category, denpyo)

        If Not latestRow Is Nothing Then
            Dim tbl As ListObject
            Set tbl = latestRow.ListObject

            frmPayee.Controls("TextBox_Amount_" & uniqueID).Value = latestRow.Cells(tbl.ListColumns("éÿï˚ã‡äz").index).Value
            frmPayee.Controls("TextBox_Amount_" & uniqueID).ForeColor = RGB(150, 150, 150)

            frmPayee.Controls("TextBox_Tekiyo1_" & uniqueID).Value = latestRow.Cells(tbl.ListColumns("ìEóv1").index).Value
            frmPayee.Controls("TextBox_Tekiyo1_" & uniqueID).ForeColor = RGB(150, 150, 150)

            frmPayee.Controls("TextBox_Tekiyo3_" & uniqueID).Value = latestRow.Cells(tbl.ListColumns("ìEóv3").index).Value
            frmPayee.Controls("TextBox_Tekiyo3_" & uniqueID).ForeColor = RGB(150, 150, 150)

            frmPayee.Controls("ComboBox_Kamoku_" & uniqueID).Value = latestRow.Cells(tbl.ListColumns("ë›ï˚â»ñ⁄").index).Value
            frmPayee.Controls("ComboBox_Kamoku_" & uniqueID).ForeColor = RGB(150, 150, 150)

            frmPayee.Controls("ComboBox_Hojo_" & uniqueID).Value = latestRow.Cells(tbl.ListColumns("ë›ï˚ï‚èï").index).Value
            frmPayee.Controls("ComboBox_Hojo_" & uniqueID).ForeColor = RGB(150, 150, 150)
        End If

        ' ìEóv2ï‚äÆ
        Dim wsReg As Worksheet
        Set wsReg = ThisWorkbook.Sheets("å˚Å@Å@ç¿")
        Dim tblReg As ListObject
        Set tblReg = wsReg.ListObjects("ÉåÉMÉÖÉâÅ[ÉäÉXÉg")

        Dim tekiyoMonthOffset As Integer: tekiyoMonthOffset = 0
        Dim r As ListRow
        For Each r In tblReg.ListRows
            With r.Range
                If .Cells(tblReg.ListColumns("éÊà¯êÊ").index).Value = payee And _
                   .Cells(tblReg.ListColumns("ÉJÉeÉSÉä").index).Value = category Then
                    tekiyoMonthOffset = Val(.Cells(tblReg.ListColumns("ìEóvåé").index).Value)
                    Exit For
                End If
            End With
        Next r

        Dim tekiyoMonth As Integer
        tekiyoMonth = selectedMonth + tekiyoMonthOffset
        If tekiyoMonth < 1 Then tekiyoMonth = tekiyoMonth + 12
        If tekiyoMonth > 12 Then tekiyoMonth = tekiyoMonth - 12

        frmPayee.Controls("TextBox_Tekiyo2_" & uniqueID).Value = tekiyoMonth & "åéï™"
        frmPayee.Controls("TextBox_Tekiyo2_" & uniqueID).ForeColor = RGB(150, 150, 150)

        frmPayee.BackColor = RGB(255, 230, 230)
    End If
End Sub



Public Function GetMonthlyDataRow(payee As String, category As String, denpyo As String, selectedYear As Integer, selectedMonth As Integer) As Range
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("å˚Å@Å@ç¿")
    Dim tbl As ListObject
    Set tbl = ws.ListObjects("Dataå˚ç¿")

    Dim latestDate As Date: latestDate = #1/1/1900#
    Dim latestRow As Range

    Dim r As ListRow
    For Each r In tbl.ListRows
        With r.Range
            If .Cells(tbl.ListColumns("éÊà¯êÊ").index).Value = payee And _
               .Cells(tbl.ListColumns("ÉJÉeÉSÉä").index).Value = category And _
               .Cells(tbl.ListColumns("ì`ï[").index).Value = denpyo And _
               .Cells(tbl.ListColumns("îN").index).Value = selectedYear And _
               .Cells(tbl.ListColumns("åé").index).Value = selectedMonth Then

                Dim d As Variant
                d = .Cells(tbl.ListColumns("éxï•ì˙").index).Value
                If IsDate(d) And d > latestDate Then
                    latestDate = d
                    Set latestRow = r.Range
                End If
            End If
        End With
    Next r

    Set GetMonthlyDataRow = latestRow
End Function


Public Sub ApplyMonthlyHistoryToFrame(frmPayee As MSForms.Frame, payee As String, dataRow As Range)
    Dim tbl As ListObject
    Set tbl = dataRow.ListObject

    ' èâä˙ílîΩâf
    frmPayee.Controls("TextBox_Amount_" & payee).Value = dataRow.Cells(tbl.ListColumns("éÿï˚ã‡äz").index).Value
    frmPayee.Controls("TextBox_Tekiyo1_" & payee).Value = dataRow.Cells(tbl.ListColumns("ìEóv1").index).Value
    frmPayee.Controls("TextBox_Tekiyo2_" & payee).Value = dataRow.Cells(tbl.ListColumns("ìEóv2").index).Value
    frmPayee.Controls("TextBox_Tekiyo3_" & payee).Value = dataRow.Cells(tbl.ListColumns("ìEóv3").index).Value
    frmPayee.Controls("TextBox_Date_" & payee).Value = Format(dataRow.Cells(tbl.ListColumns("éxï•ì˙").index).Value, "yyyy/mm/dd")
    frmPayee.Controls("ComboBox_Kamoku_" & payee).Value = dataRow.Cells(tbl.ListColumns("ë›ï˚â»ñ⁄").index).Value
    frmPayee.Controls("ComboBox_Hojo_" & payee).Value = dataRow.Cells(tbl.ListColumns("ë›ï˚ï‚èï").index).Value
    ' îwåiêFÅFï€ë∂çœÇ›ÅióŒÅj
    frmPayee.BackColor = RGB(230, 255, 230)
End Sub

Public Sub AddSaveButtonToFrame(frmPayee As MSForms.Frame, payee As String)
    frmPayee.Controls.Add "Forms.CommandButton.1", "CommandButton_Save_" & payee
    With frmPayee.Controls("CommandButton_Save_" & payee)
        .caption = "ï€ë∂"
        .Left = 10
        .Top = frmPayee.Height - 30
        .Width = 60
    End With
End Sub

Public Sub SetKamokuDropdown(cmb As MSForms.ComboBox)
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("ä®íËâ»ñ⁄")
    Dim tbl As ListObject
    Set tbl = ws.ListObjects("ä®íËâ»ñ⁄")

    Dim r As ListRow
    cmb.Clear

    For Each r In tbl.ListRows
        With r.Range
            If .Cells(tbl.ListColumns("ëÂÉJÉeÉSÉä").index).Value = "éëéYÇÃïî" Then
                cmb.AddItem .Cells(tbl.ListColumns("ä®íËâ»ñ⁄").index).Value
            End If
        End With
    Next r
End Sub

Public Sub SetHojoDropdown(cmb As MSForms.ComboBox)
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("BK")
    Dim tbl As ListObject
    Set tbl = ws.ListObjects("BK")

    Dim r As ListRow
    cmb.Clear

    For Each r In tbl.ListRows
        With r.Range
            cmb.AddItem .Cells(tbl.ListColumns("ï‚èïâ»ñ⁄").index).Value
        End With
    Next r
End Sub
Private Function GetPageIndexByCaption(mp As MSForms.MultiPage, caption As String) As Integer
    Dim i As Integer
    For i = 0 To mp.Pages.Count - 1
        If mp.Pages(i).caption = caption Then
            GetPageIndexByCaption = i
            Exit Function
        End If
    Next i
    GetPageIndexByCaption = -1
End Function


Public Sub SaveSingleEntry(frm As RegularPaymentForm, frameID As String, denpyo As String)
    Dim payee As String
    payee = Split(frameID, "_")(0)
    Dim category As String
    category = frm.ComboBox_Category.Value

    ' === äYìñì`ï[ÉyÅ[ÉWÇéÊìæ ===
    Dim pageIndex As Integer
    pageIndex = GetPageIndexByCaption(frm.MultiPage_Denpyo, denpyo)

    If pageIndex = -1 Then
        MsgBox "ì`ï[ÉyÅ[ÉWÇ™å©Ç¬Ç©ÇËÇ‹ÇπÇÒÅF" & denpyo, vbExclamation
        Exit Sub
    End If

    Dim pg As Object
    Set pg = frm.MultiPage_Denpyo.Pages(pageIndex)

    ' === äYìñÉtÉåÅ[ÉÄÇéÊìæ ===
    Dim ctrlFrame As MSForms.Frame
    On Error Resume Next
    Set ctrlFrame = pg.Controls("Frame_Payee_" & frameID)
    On Error GoTo 0

    If ctrlFrame Is Nothing Then
        MsgBox "éÊà¯êÊÉtÉåÅ[ÉÄÇ™å©Ç¬Ç©ÇËÇ‹ÇπÇÒÅF" & frameID, vbExclamation
        Exit Sub
    End If

    ' === ì¸óÕíléÊìæ ===
    Dim amount As Double
    amount = Val(ctrlFrame.Controls("TextBox_Amount_" & frameID).Value)

    Dim tekiyo2 As String
    tekiyo2 = ctrlFrame.Controls("TextBox_Tekiyo2_" & frameID).Value

    Dim shiharaiDate As Date
    shiharaiDate = DateValue(ctrlFrame.Controls("TextBox_Date_" & frameID).Value)

    Dim kamoku As String
    kamoku = ctrlFrame.Controls("ComboBox_Kamoku_" & frameID).Value
    Dim hojo As String
    hojo = ctrlFrame.Controls("ComboBox_Hojo_" & frameID).Value

    ' === óöóéÊìæ ===
    Dim prevData As Variant
    prevData = GetPreviousMonthData(payee, category, denpyo, frm.SpinButton_Month.Value)

    Dim tekiyo1 As String, tekiyo3 As String
    tekiyo1 = prevData(2)
    tekiyo3 = prevData(4)

    ' === ï€ë∂èàóù ===
    Dim wsData As Worksheet
    Set wsData = ThisWorkbook.Sheets("å˚Å@Å@ç¿")
    Dim tblData As ListObject
    Set tblData = wsData.ListObjects("Dataå˚ç¿")

    Dim newRow As ListRow
    Set newRow = tblData.ListRows.Add

    With newRow.Range
        .Cells(tblData.ListColumns("éxï•ì˙").index).Value = shiharaiDate
        .Cells(tblData.ListColumns("éÊà¯êÊ").index).Value = payee
        .Cells(tblData.ListColumns("ÉJÉeÉSÉä").index).Value = category
        .Cells(tblData.ListColumns("ì`ï[").index).Value = denpyo
        .Cells(tblData.ListColumns("No").index).Value = tblData.ListRows.Count
        .Cells(tblData.ListColumns("çsî‘").index).Value = 0 ' íPàÍçsÇ∆ÇµÇƒï€ë∂

        .Cells(tblData.ListColumns("éÿï˚ã‡äz").index).Value = amount
        .Cells(tblData.ListColumns("ë›ï˚ã‡äz").index).Value = amount
        .Cells(tblData.ListColumns("ìEóv1").index).Value = tekiyo1
        .Cells(tblData.ListColumns("ìEóv2").index).Value = tekiyo2
        .Cells(tblData.ListColumns("ìEóv3").index).Value = tekiyo3

        .Cells(tblData.ListColumns("ë›ï˚ï‚èï").index).Value = hojo
    End With

    ' === éãäoìIÉtÉBÅ[ÉhÉoÉbÉN ===
    Dim ctrlList As New Collection
    ctrlList.Add ctrlFrame.Controls("TextBox_Amount_" & frameID)
    ctrlList.Add ctrlFrame.Controls("TextBox_Tekiyo1_" & frameID)
    ctrlList.Add ctrlFrame.Controls("TextBox_Tekiyo2_" & frameID)
    ctrlList.Add ctrlFrame.Controls("TextBox_Tekiyo3_" & frameID)
    Call FinalizeSave(ctrlList, ctrlFrame)

    MsgBox "ï€ë∂ÇµÇ‹ÇµÇΩÅF" & payee, vbInformation
End Sub




Public Sub FilterDataByPayee(frameID As String)
    Dim payee As String
    payee = Split(frameID, "_")(0)

    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("å˚Å@Å@ç¿")
    Dim tbl As ListObject
    Set tbl = ws.ListObjects("Dataå˚ç¿")

    If ws.AutoFilterMode Then ws.ShowAllData

    Dim colIndex As Long
    colIndex = tbl.ListColumns("éÊà¯êÊ").index

    tbl.Range.AutoFilter Field:=colIndex, Criteria1:=payee
End Sub


Public Function GetLatestHistoryRow(payee As String, category As String, denpyo As String) As Range
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("å˚Å@Å@ç¿")
    Dim tbl As ListObject
    Set tbl = ws.ListObjects("Dataå˚ç¿")

    Dim latestDate As Date: latestDate = #1/1/1900#
    Dim latestRow As Range

    Dim r As ListRow
    For Each r In tbl.ListRows
        With r.Range
            If .Cells(tbl.ListColumns("éÊà¯êÊ").index).Value = payee And _
               .Cells(tbl.ListColumns("ÉJÉeÉSÉä").index).Value = category And _
               .Cells(tbl.ListColumns("ì`ï[").index).Value = denpyo Then

                Dim d As Variant
                d = .Cells(tbl.ListColumns("éxï•ì˙").index).Value
                If IsDate(d) And d > latestDate Then
                    latestDate = d
                    Set latestRow = r.Range
                End If
            End If
        End With
    Next r

    Set GetLatestHistoryRow = latestRow
End Function



' === ëOåéÉfÅ[É^éÊìæ ===

Public Function GetPreviousMonthData(payee As String, category As String, denpyo As String, selectedMonth As Integer) As Variant

    Dim tbl As ListObject
    Set tbl = ThisWorkbook.Sheets("å˚Å@Å@ç¿").ListObjects("Dataå˚ç¿")

    Dim prevMonth As Integer, prevYear As Integer
    If selectedMonth = 1 Then
        prevMonth = 12
        prevYear = year(Date) - 1
    Else
        prevMonth = selectedMonth - 1
        prevYear = year(Date)
    End If
    Dim r As ListRow
    Dim result(1 To 4) As Variant
    Dim totalAmount As Double: totalAmount = 0
    Dim tekiyo1List As Object: Set tekiyo1List = CreateObject("Scripting.Dictionary")
    Dim tekiyo2List As Object: Set tekiyo2List = CreateObject("Scripting.Dictionary")
    Dim tekiyo3List As Object: Set tekiyo3List = CreateObject("Scripting.Dictionary")

    For Each r In tbl.ListRows
        With r.Range
            If .Cells(tbl.ListColumns("éÊà¯êÊ").index).Value = payee And _
               .Cells(tbl.ListColumns("ÉJÉeÉSÉä").index).Value = category And _
               .Cells(tbl.ListColumns("îN").index).Value = prevYear And _
               .Cells(tbl.ListColumns("åé").index).Value = prevMonth Then

                totalAmount = totalAmount + Val(.Cells(tbl.ListColumns("éÿï˚ã‡äz").index).Value)

                Dim t1 As String: t1 = Trim(.Cells(tbl.ListColumns("ìEóv1").index).Value)
                Dim t2 As String: t2 = Trim(.Cells(tbl.ListColumns("ìEóv2").index).Value)
                Dim t3 As String: t3 = Trim(.Cells(tbl.ListColumns("ìEóv3").index).Value)

                If Len(t1) > 0 Then tekiyo1List(t1) = 1
                If Len(t2) > 0 Then tekiyo2List(t2) = 1
                If Len(t3) > 0 Then tekiyo3List(t3) = 1
            End If
        End With
    Next r

    result(1) = totalAmount
    result(2) = Join(tekiyo1List.Keys, "Å^")
    result(3) = Join(tekiyo2List.Keys, "Å^")
    result(4) = Join(tekiyo3List.Keys, "Å^")

    GetPreviousMonthData = result
End Function

' === ï€ë∂å„Ç…êFÇçïÇ…ïœçXÇµÅAîwåiêFÇóŒÇ… ===
Public Sub FinalizeSave(ctrls As Collection, frameCtrl As Object)
    Dim ctrl As Object
    For Each ctrl In ctrls
        ctrl.ForeColor = RGB(0, 0, 0)
    Next ctrl
    frameCtrl.BackColor = RGB(230, 255, 230) ' ï€ë∂çœÇ›ÅióŒÅj
End Sub
